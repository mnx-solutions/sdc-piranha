<div class="container-fluid" data-ng-controller="Firewall.IndexController">


    <div class="container">
        <div data-breadcrumb></div>
        <div class="beta-sticker"></div>
        <div data-notification></div>
        <div class="row-fluid">
            <div class="span12">
                <h1>Cloud Firewall<div data-ng-show="loading" class="loading-medium-after-h1"></div></h1>
            </div>
        </div>
        <div data-ng-hide="(rules.length || loading)">
            <div class="alert alert-joyent-blue alert-global">
                <div class="pull-left">
                    <h4>Hello there!</h4>
                    <div>You don't have any Cloud Firewall rules.
                        <ol>
                            <li>Add a new rule for your SmartOS instances.</li>
                            <li>Enable the Cloud Firewall on each VM you wish to use this feature on.</li>
                        </ol>
                    </div>
                </div>
                <div class="row-fluid" style="margin-top: 45px">
                    <button class="btn btn-joyent-blue pull-right alert-global add-rule-btn"
                            data-ng-hide="data.uuid" data-ng-click="toggleOpenRuleForm()">+ Add New Rule</button>
                </div>
                <div class="clearfix"></div>
            </div>
        </div>
        <div class="row" data-ng-show="rules.length">
            <div class="span12">
                <div data-grid-view
                     data-props="gridProps"
                     data-objects="rules"
                     data-per-page="15"
                     data-order="gridOrder"
                     data-objects-type="firewall"></div>
            </div>
        </div>

        <div data-ng-show="loading" class="loading-large"></div>

        <div class="form-horizontal" data-ng-hide="loading" data-ng-model="data">
            <fieldset>
                <legend class="text-right">
                    <span data-ng-show="data.uuid">Edit rule {{data.uuid}} <a class="pointer" data-ng-click="resetData()">(create new instead)</a></span>
                    <button class="btn btn-joyent-blue" style="margin-top:-100px;" data-ng-hide="data.uuid || !rules.length" data-ng-click="toggleOpenRuleForm()" data-ng-disabled="machinesLoading">+ Add New Rule</button>
                </legend>

                <div data-ng-show="openRuleForm">
                <div class="row">
                    <div class="span12 fw-left-part fw-input-container">
                        <div class="row">
                            <div class="span8">
<p>Cloud Firewall rules limit network traffic for your SmartOS instances in one system. Cloud Firewall will enforce applicable rules for each instance that has Cloud Firewall enabled in its Instance Details.</p>
<p>There is no ordering to your own rules and if there are contradictory rules the least restrictive rule is used. ICMP 8:0 is always open to support echo requests using <code class="plain">ping.</code></p>
                            </div>

                            <div class="span4">
                                <form class="form-horizontal">
                                    <div class="control-group">
                                        <label class="control-label" for="actionSelect">Action</label>
                                        <div class="controls">
                                            <input type="hidden" id="actionSelect">
                                        </div>
                                    </div>

                                    <div class="control-group">
                                        <label class="control-label" for="stateSelect">State</label>
                                        <div class="controls">
                                            <input type="hidden" id="stateSelect">
                                        </div>
                                    </div>

                                    <div class="control-group">
                                        <label class="control-label" for="dcSelect">Datacenter</label>
                                        <div class="controls">
                                            <input type="hidden" id="dcSelect">
                                        </div>
                                    </div>

                                </form>
                            </div>


                        </div>
                    </div>
                </div>


                 <div class="row">
                    <div class="span2 fw-left-part fw-input-container">
                        <legend data-translate>Protocol</legend>
                        <div>
                            <input type="hidden" id="protocolSelect" />
                        </div><br/>
                        <div data-ng-form="protocolForm">
                            <label class="fw-control-label" data-ng-show="data.parsed.protocol.name && data.parsed.protocol.name != 'icmp'">Port</label>
                            <div class="fw-controls fw-port-controls warning" data-ng-show="data.parsed.protocol.name && data.parsed.protocol.name != 'icmp'">
                                <input id="port"
                                       class="port"
                                       name="port"
                                       type="text"
                                       data-ng-model="current.port"
                                       data-range="1-65535"/>
                            </div>

                            <div class="warning" data-ng-show="data.parsed.protocol.name && data.parsed.protocol.name == 'icmp'">
                                <label class="fw-control-label">
                                    <span>Type:</span>
                                </label>
                                <div class="fw-controls fw-port-controls">
                                    <input type="text"
                                           name="type"
                                           class="port"
                                           required="true"
                                           data-range="0-255"
                                           data-ng-model="current.type" />
                                </div>

                                <label class="fw-control-label margin-top-10">
                                    <span>Code:</span>
                                </label>
                                <div class="fw-controls fw-port-controls margin-top-10">
                                    <input type="text"
                                           name="code"
                                           class="port"
                                           required="false"
                                           data-range="0-255"
                                           data-ng-model="current.code" />
                                </div>
                            </div>
                        </div>
                        </div>

                        <div class="span5 fw-middle-part fw-input-container">
                        <legend data-translate>From</legend>
                            <label class="fw-control-label">Add</label>
                            <div class="fw-controls">
                                <span class="text-medium">
                                    <input type="hidden" id="fromSelect" /><br /><br />
                                </span>
                            </div>
                            <span class="text-medium" data-ng-form="fromForm">
                                <span data-ng-switch="current.from.type">
                                    <span data-ng-switch-when="wildcard">

                                    </span>
                                    <span data-ng-switch-when="tag">
                                        <div class="fw-control-label">Tag Name</div>
                                        <div class="fw-controls">
                                            <input type="text" data-ng-model="current.from.text" required/>
                                        </div>
                                        <div data-ng-show="current.from.text" class="row-fluid margin-top-10">
                                            <div class="fw-control-label">Tag Value</div>
                                            <div class="fw-controls">
                                                <input type="text" data-ng-model="current.from.value" />
                                            </div>
                                        </div>
                                    </span>
                                    <span data-ng-switch-default>
                                        <!-- due to the nature of directives, we need another switch here -->
                                        <span data-ng-switch="current.from.type">
                                            <span data-ng-switch-when="subnet">
                                                <div class="fw-control-label">Subnet</div>
                                                <div class="fw-controls">
                                                    <input  type="text" name="fromValue" data-ng-model="fromSubnet.address" data-ip required/>
                                                </div>
                                                <div data-ng-show="current.from.text" class="row-fluid margin-top-10">
                                                    <div class="fw-control-label">CIDR</div>
                                                    <div class="fw-controls">
                                                        <select data-ng-options="c for c in CIDRs" data-ng-model="fromSubnet.CIDR"> </select>
                                                    </div>
                                                </div>
                                            </span>
                                            <span data-ng-switch-when="ip">
                                                <div class="fw-control-label">IP</div>
                                                <div class="fw-controls">
                                                    <input type="text" name="fromValue" data-ng-model="current.from.text" data-ip required />
                                                </div>
                                            </span>
                                            <span data-ng-switch-default>
                                                <div class="fw-control-label">uuid</div>
                                                <div class="fw-controls">
                                                    <input type="hidden" id="fromInstanceSelect" />
                                                </div>
                                            </span>
                                        </span>
                                        <!-- directives switch end -->
                                    </span>
                                </span>
                            </span>
                        </div>


                      <div class="span5 fw-right-part fw-input-container">
                        <legend data-translate>To</legend>

                          <label class="fw-control-label">Add</label>
                          <div class="fw-controls">
                                <span class="text-medium">
                                    <input type="hidden" id="toSelect" /><br/><br/>
                                </span>
                          </div>
                            <span class="text-medium" data-ng-form="toForm">
                                <span data-ng-switch="current.to.type">
                                    <span data-ng-switch-when="wildcard">

                                    </span>
                                    <span data-ng-switch-when="tag">
                                        <div class="fw-control-label">Tag name</div>
                                        <div class="fw-controls">
                                            <input type="text" data-ng-model="current.to.text" required />
                                        </div>
                                        <div data-ng-show="current.to.text" class="row-fluid margin-top-10">
                                            <div class="fw-control-label">Tag value</div>
                                            <div class="fw-controls">
                                                <input type="text" data-ng-model="current.to.value" />
                                            </div>
                                        </div>
                                    </span>
                                    <span data-ng-switch-default>
                                        <!-- due to the nature of directives, we need another switch here -->
                                        <span data-ng-switch="current.to.type">
                                            <span data-ng-switch-when="subnet">
                                                <div class="fw-control-label">Subnet</div>
                                                <div class="fw-controls">
                                                    <input type="text" name="toValue" data-ng-model="toSubnet.address" data-ip required />
                                                </div>
                                                <div data-ng-show="current.to.text" class="row-fluid margin-top-10">
                                                    <div class="fw-control-label">CIDR</div>
                                                    <div class="fw-controls">
                                                        <select data-ng-options="c for c in CIDRs" data-ng-model="toSubnet.CIDR"> </select>
                                                    </div>
                                                </div>
                                            </span>
                                            <span data-ng-switch-when="ip">
                                                <div class="fw-control-label">IP</div>
                                                <div class="fw-controls">
                                                    <input type="text" name="toValue" data-ng-model="current.to.text" data-ip required />
                                                </div>
                                            </span>
                                            <span data-ng-switch-default>
                                                <div class="fw-control-label">uuid</div>
                                                <div class="fw-controls">
                                                    <input type="hidden" class="select2-input" id="toInstanceSelect" />
                                                </div>
                                            </span>
                                        </span>
                                        <!-- directives switch end -->
                                    </span>
                                </span>
                            </span>
                        </div>

                  </div>

                 <!-- button row -->
                 <div class="row">
                     <div class="span2 fw-left-part">

                         <div class="margin-top-10" data-ng-show="data.parsed.protocol.name && data.parsed.protocol.name != 'icmp'">
                             <button class="btn"
                                     data-ng-disabled="!protocolForm.port.$dirty || protocolForm.port.$error.range"
                                     data-ng-click="addPort()">Add</button>
                             <button class="btn" data-ng-click="useAllPorts()">USE ALL</button>
                         </div>

                         <div class="warning" data-ng-show="data.parsed.protocol.name && data.parsed.protocol.name == 'icmp'">
                             <div class="margin-top-10">
                                 <button class="btn"
                                         data-ng-disabled="!protocolForm.type.$valid || !protocolForm.code.$valid"
                                         data-ng-click="addType()">ADD</button>
                             </div>
                         </div>
                     </div>
                     <div class="span5 fw-middle-part">

                        <span data-ng-switch="current.from.type">
                            <span data-ng-switch-when="wildcard">
                                <span>
                                    <span class="row-fluid">
                                        <div class="margin-top-10">
                                            <button class="btn pull-right" data-ng-disabled="current.from.text != 'all vms' && current.from.text != 'any'" data-ng-click="addFrom()">ADD FROM</button>
                                        </div>
                                    </span>
                                </span>
                            </span>
                            <span data-ng-switch-when="tag">
                                <span class="row-fluid">
                                    <div class="margin-top-10">
                                        <button class="btn pull-right" data-ng-click="addFrom()" data-ng-disabled="fromForm.$invalid || fromForm.$pristine">ADD FROM</button>
                                    </div>
                                </span>
                            </span>
                            <span data-ng-switch-default>

                                <span class="row-fluid">
                                    <div class="margin-top-10">
                                        <button class="btn pull-right" data-ng-click="addFrom()" data-ng-disabled="fromForm.$invalid || fromForm.$pristine">ADD FROM</button>
                                    </div>
                                </span>
                            </span>
                        </span>
                     </div>
                     <div class="span5 fw-right-part">

                        <span data-ng-switch="current.to.type">
                            <span data-ng-switch-when="wildcard">
                                <span>
                                    <span class="row-fluid">
                                        <div class="margin-top-10">
                                            <button class="btn pull-right" data-ng-disabled="current.to.text != 'all vms' && current.to.text != 'any'" data-ng-click="addTo()">ADD TO</button>
                                        </div>
                                    </span>
                                </span>
                            </span>
                            <span data-ng-switch-when="tag">
                                <span class="row-fluid">
                                    <div class="margin-top-10">
                                        <button class="btn pull-right" data-ng-click="addTo()" data-ng-disabled="toForm.$invalid || toForm.$pristine">ADD TO</button>
                                    </div>
                                </span>
                            </span>
                            <span data-ng-switch-default>
                                <span class="row-fluid">
                                    <div class="margin-top-10">
                                        <button class="btn pull-right" data-ng-click="addTo()" data-ng-disabled="toForm.$invalid || toForm.$pristine">ADD TO</button>
                                    </div>
                                </span>
                            </span>
                        </span>

                     </div>
                 </div>
                <br/>
                <!-- end of button row -->

                    <div class="row fw-horizontal-group">
                        <!-- start of left part -->
                        <div class="span2 fw-left-part fw-input-container">
                            <div class="error" data-ng-hide="data.parsed.protocol.targets.length">
                                No ports added
                            </div>
                            <table class="table table-bordered fw-data-table" data-ng-show="data.parsed.protocol.targets.length">
                                <tr data-ng-repeat="target in data.parsed.protocol.targets">
                                    <td>{{target}}</td>
                                    <td class="remove"><i class="icon-remove" data-ng-click="removeProtocolTarget($index)"></i></td>
                                </tr>
                            </table>
                        </div>
                        <!-- end of left part -->

                        <!-- start of middle part -->
                        <div class="span5 fw-middle-part fw-input-container">
                            <div class="error" ng-hide="data.parsed.from.length">
                                No sources added
                            </div>

                            <table class="table table-bordered fw-data-table"  ng-show="data.parsed.from.length">

                                <tr data-ng-repeat="from in data.parsed.from">
                                    <td>{{from|targetInfo}}</td>
                                    <td class="remove"><i class="icon-remove" data-ng-click="removeFrom($index)"></i></td>
                                </tr>
                            </table>
                        </div>
                        <!-- end of middle part -->

                        <!-- start of right part -->
                        <div class="span5 fw-right-part fw-input-container">

                            <div class="error" ng-hide="data.parsed.to.length">
                                No targets added
                            </div>

                            <!-- added data table -->
                            <table class="table table-bordered fw-data-table" ng-show="data.parsed.to.length">
                                <tr data-ng-repeat="to in data.parsed.to">
                                    <td>{{to|targetInfo}}</td>
                                    <td class="remove"><i class="icon-remove" data-ng-click="removeTo($index)"></i></td>
                                </tr>
                            </table>
                        </div>
                        <!-- end of right part -->
                    </div>

                    <div class="row">
                        <div class="span12">
                            <div class="ff-form-actions text-right fw-form-buttons">
                                <button class="btn btn-primary" data-ng-click="saveRule()" data-translate-value>{{data.uuid && 'Update Rule' || 'Create Rule'}}</button>
                            </div>
                        </div>
                    </div>
                    <hr/>
                </div>

            </fieldset>
        </div>
        <div class="row-fluid notice-block" data-ng-show="notAffectedMachines.length > 0 || firewallDisabledMachines.length > 0 || kvmList.length > 0">
            The Firewall API is a SmartDataCenter 7.0 platform feature. It currently supports SmartOS instances. <a href="http://wiki.joyent.com/wiki/display/jpc2/Working+With+Firewall+Rules">Click here to learn more about working with Firewall Rules</a>.
            <br />
        </div>
        <div class="row-fluid notice-block" data-ng-show="notAffectedMachines.length > 0">
            The following instances will not benefit from this feature until their global zone is upgraded by Joyent staff as part of the Q4 2013 through Q1 2014 maintenance:
            <div data-ng-repeat="machine in notAffectedMachines">
                <a href="#!/compute/instance/{{machine.id}}">{{$index+1}}. {{machine.name}} <span class="muted">({{machine.id}})</span></a>
            </div>
        </div>
        <div class="row-fluid notice-block" data-ng-show="firewallDisabledMachines.length > 0">
            The following instances do not have Firewall Rules enabled. You can view all of the rules that apply to each instance on their own instance details page. There you can also enable the Firewall Rules or by using <a href="http://apidocs.joyent.com/cloudapi/#firewallrules">CloudAPI</a>:
            <div data-ng-repeat="machine in firewallDisabledMachines">
                <a href="#!/compute/instance/{{machine.id}}">{{$index+1}}. {{machine.name}} <span class="muted">({{machine.id}})</span></a>
            </div>
        </div>
        <div class="row-fluid notice-block" data-ng-show="kvmList.length > 0">
            Linux, BSD, and Windows instances are not yet supported:
            <div data-ng-repeat="machine in kvmList">
                <a href="#!/compute/instance/{{machine.id}}">{{$index+1}}. {{machine.name}} <span class="muted">({{machine.id}})</span></a>
            </div>
        </div>
    </div>
</div>


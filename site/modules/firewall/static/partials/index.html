<div class="container-fluid container-position" data-ng-controller="Firewall.IndexController">
    <div data-breadcrumbs></div>
    <div class="page-header row">
        <h3 class="page-title">{{ pageTitle }}</h3>
        <div class="beta-sticker">beta</div>
    </div>
    <div class="loading-large" data-ng-show="loading"></div>

    <div data-ng-hide="(rules.length || loading)" class="pull-left">
        <h4>Hello there!</h4>
        <div>You don't have any Cloud Firewall rules.
            <ol>
                <li>Add a new rule for your SmartOS instances.</li>
                <li>Enable the Cloud Firewall on each instance you wish to use this feature on.</li>
            </ol>
        </div>
    </div>
    <div data-ng-show="rules.length && !loading">
        <div data-grid-view
             data-user-config="gridUserConfig"
             data-props="gridProps"
             data-action-buttons="gridActionButtons"
             data-enabled-checkboxes="enabledCheckboxes"
             data-multisort="false"
             data-items="rules"
             data-order="gridOrder"
             data-search-form="searchForm"
             data-filter-all="{{query}}"
             data-place-Holder-Text="placeHolderText"
             data-export-fields="exportFields"
             data-items-type="firewall"
             data-tab-filter-field="'datacenter'"
             data-tab-filter-default="tabFilterDefault"
             data-tab-filter-update="tabFilterUpdate"
             data-no-entries-message-error-type="dcUnreachable"
             data-checked-items="checkedItems">
        </div>
    </div>
    <button class="btn orange pull-right add-rule-btn" data-ng-class="{'no-rules' : !rules.length}" data-ng-hide="openRuleForm || machinesLoading" data-ng-click="toggleOpenRuleForm()">+ Add New Rule</button>
    <div class="clearfix"></div>
    <div class="form-horizontal" data-ng-hide="loading" data-ng-model="data">
        <div class="item-list-container">
            <hr />

            <div data-ng-show="openRuleForm" id="create-rule">
                <div class="row">
                    <p class="description">Cloud Firewall rules limit network traffic for your SmartOS instances in one system. Cloud Firewall will enforce applicable rules for each instance that has Cloud Firewall enabled in its Instance Details.</p>
                    <p class="description">There is no ordering to your own rules. For incoming traffic, the least restrictive rule wins. For outgoing traffic, the most restrictive rule wins. ICMP 8:0 is always open to support echo requests using <code class="plain">ping.</code></p>
                </div>

                <legend data-ng-show="data.uuid" class="margin-top-10" id="edit-rule">Edit rule {{data.uuid}}</legend>
                <table class="firewall-table">
                <thead class="create-rule-header">
                <tr>
                    <td class="controls-wrapper">
                        <label class="fw-control-label name-field">Status</label>
                        <div class="value-field">
                            <select ui-select2="{minimumResultsForSearch: -1, width: '105px'}" id="stateSelect" data-ng-model="selected.status">
                                <option data-ng-repeat="state in selectData.states" value="{{state.id}}">
                                    {{state.text}}
                                </option>
                            </select>
                        </div>
                    </td>
                    <td class="controls-wrapper">
                        <label class="fw-control-label name-field">Datacenter:</label>
                        <div class="value-field">
                            <select ui-select2="{minimumResultsForSearch: -1, width: '115px'}" id="dcSelect" data-ng-model="selected.datacenter">
                                <option data-ng-repeat="datacenter in selectData.datacenters" value="{{datacenter.text}}">
                                    {{datacenter.text}}
                                </option>
                            </select>
                        </div>
                        <div class="loading-medium loading-medium-inline" data-ng-show="datasetsLoading"></div>
                    </td>
                </tr>
                </thead>
                <tbody>
                <tr>
                <td class="column column-big min-height-table">
                    <legend data-translate>Protocol</legend>
                    <div>
                        <select ui-select2="{minimumResultsForSearch: -1, width: '100%'}" id="protocolSelect" data-ng-model="data.parsed.protocol.name">
                            <option data-ng-repeat="protocol in selectData.protocols" value="{{protocol.id}}">
                                {{protocol.text}}
                            </option>
                        </select>
                    </div><br/>
                    <div class="fixed-height">
                        <div data-ng-form="protocolForm">
                            <label class="fw-control-label" data-ng-show="data.parsed.protocol.name && data.parsed.protocol.name != 'icmp'">Port</label>
                            <div class="fw-controls fw-port-controls warning" data-ng-show="data.parsed.protocol.name && data.parsed.protocol.name != 'icmp'">
                                <input id="port"
                                       class="port"
                                       name="port"
                                       type="text"
                                       data-ng-model="current.port"
                                       data-range="1-65535" />
                            </div>

                            <div class="warning" data-ng-show="data.parsed.protocol.name && data.parsed.protocol.name == 'icmp'">
                                <label class="fw-control-label">
                                    <span>Type:</span>
                                </label>
                                <div class="fw-controls fw-port-controls">
                                    <input type="text"
                                           name="type"
                                           class="port"
                                           required="true"
                                           data-range="0-255"
                                           data-ng-model="current.type" />
                                </div>

                                <label class="fw-control-label margin-top-10">
                                    <span>Code:</span>
                                </label>
                                <div class="fw-controls fw-port-controls margin-top-10">
                                    <input type="text"
                                           name="code"
                                           class="port"
                                           required="false"
                                           data-range="0-255"
                                           data-ng-model="current.code" />
                                </div>
                            </div>
                        </div>
                        <div class="margin-top-10 pull-right" data-ng-show="data.parsed.protocol.name && data.parsed.protocol.name != 'icmp'">
                            <button class="btn light effect-orange-button" data-ng-click="useAllPorts()">Use All</button>
                            <button class="btn orange"
                                    data-ng-disabled="!protocolForm.port.$dirty || protocolForm.port.$error.range"
                                    data-ng-click="addPort()">Add</button>
                        </div>

                        <div class="warning" data-ng-show="data.parsed.protocol.name && data.parsed.protocol.name == 'icmp'">
                            <div class="margin-top-10 pull-right">
                                <button class="btn light effect-orange-button"
                                        data-ng-disabled="!protocolForm.type.$valid || !protocolForm.code.$valid"
                                        data-ng-click="addType()">Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="results-group">
                                        <span class="f-result" data-ng-hide="data.parsed.protocol.targets.length">
                                            <div class="error" >
                                                No ports added
                                            </div>
                                        </span>
                                        <span data-ng-show="data.parsed.protocol.targets.length">
                                            <span class="f-result" data-ng-repeat="target in data.parsed.protocol.targets">
                                                <div class="remove-icon delete pull-right tags-delete-pos" data-ng-click="removeProtocolTarget($index)" ></div>
                                                <div class="result-width">{{target}}</div>
                                            </span>
                                        </span>
                    </div>
                </td>
                <td class="column column-big min-height-table">
                    <legend data-translate>From</legend>
                    <div>
                                        <span class="text-large">
                                            <input type="hidden" id="fromSelect" /><br /><br />
                                        </span>
                    </div>
                    <div class="fixed-height">
                                        <span class="text-large" data-ng-form="fromForm">
                                        <span data-ng-switch="current.from.type">
                                            <span data-ng-switch-when="wildcard"></span>
                                            <span data-ng-switch-when="tag">
                                                <label class="fw-control-label">Key</label>
                                                <div class="fw-controls">
                                                    <input type="text" data-ng-model="current.from.text" required/>
                                                </div>
                                                <div data-ng-show="current.from.text" class="row margin-top-10">
                                                    <label class="fw-control-label">Value</label>
                                                    <div class="fw-controls">
                                                        <input type="text" data-ng-model="current.from.value" />
                                                    </div>
                                                </div>
                                            </span>
                                            <span data-ng-switch-default>
                                                <!-- due to the nature of directives, we need another switch here -->
                                                <span data-ng-switch="current.from.type">
                                                    <span data-ng-switch-when="subnet">
                                                        <label class="fw-control-label">Subnet</label>
                                                        <div class="fw-controls">
                                                            <input  type="text" name="fromValue" data-ng-model="fromSubnet.address" data-ip required/>
                                                        </div>
                                                        <div data-ng-show="current.from.text" class="row margin-top-10">
                                                            <label class="fw-control-label">CIDR</label>
                                                            <div class="fw-controls">
                                                                <select data-ng-options="c for c in CIDRs" data-ng-model="fromSubnet.CIDR"> </select>
                                                            </div>
                                                        </div>
                                                    </span>
                                                    <span data-ng-switch-when="ip">
                                                        <label class="fw-control-label">IP</label>
                                                        <div class="fw-controls">
                                                            <input type="text" name="fromValue" data-ng-model="current.from.text" data-ip required />
                                                        </div>
                                                    </span>
                                                    <span data-ng-switch-when="vm">
                                                        <label class="fw-control-label">UUID</label>
                                                        <div class="fw-controls">
                                                            <input type="hidden" id="fromInstanceSelect" />
                                                        </div>
                                                    </span>
                                                </span>
                                                <!-- directives switch end -->
                                            </span>
                                        </span>
                                    </span>
                                    <span data-ng-switch="current.from.type">
                                        <span data-ng-switch-when="wildcard">
                                            <span>
                                                <span class="row">
                                                    <div class="margin-top-10">
                                                        <button class="btn light pull-right effect-orange-button" data-ng-disabled="current.from.text != 'vmall' && current.from.text != 'any'" data-ng-click="addFrom()">Add</button>
                                                    </div>
                                                </span>
                                            </span>
                                        </span>
                                        <span data-ng-switch-when="tag">
                                            <span class="row">
                                                <div class="margin-top-10">
                                                    <button class="btn light pull-right effect-orange-button" data-ng-click="addFrom()" data-ng-disabled="fromForm.$invalid || fromForm.$pristine">Add</button>
                                                </div>
                                            </span>
                                        </span>
                                        <span data-ng-switch-default>
                                            <span class="row">
                                                <div class="margin-top-10">
                                                    <button class="btn light pull-right effect-orange-button" data-ng-click="addFrom()" data-ng-disabled="fromForm.$invalid || fromForm.$pristine">Add</button>
                                                </div>
                                            </span>
                                        </span>
                                    </span>
                    </div>

                    <div class="results-group">
                                        <span class="f-result" ng-hide="data.parsed.from.length">
                                            <div class="error" >
                                                No sources added
                                            </div>
                                        </span>

                                        <span data-ng-show="data.parsed.from.length" class="">
                                            <span class="f-result" data-ng-repeat="from in data.parsed.from">
                                                <div class="remove-icon delete pull-right tags-delete-pos" data-ng-click="removeFrom($index)"></div>
                                                <div class="result-width">{{from|targetInfo}}</div>
                                            </span>
                                        </span>
                    </div>
                </td>
                <td class="column column-small min-height-table">
                    <legend data-translate>Action</legend>
                    <div>
                        <select ui-select2="{minimumResultsForSearch: -1, width: '100%'}" id="actionSelect" data-ng-model="data.parsed.action">
                            <option data-ng-repeat="action in selectData.actions" value="{{action.id}}">
                                {{action.text}}
                            </option>
                        </select>
                    </div>
                </td>
                <td class="column column-big min-height-table">
                    <legend data-translate>To</legend>
                    <div>
                                        <span class="text-large">
                                            <input type="hidden" id="toSelect" /><br/><br/>
                                        </span>
                    </div>
                    <div class="fixed-height">
                                        <span class="text-large" data-ng-form="toForm">
                                        <span data-ng-switch="current.to.type">
                                            <span data-ng-switch-when="wildcard">
                                        </span>
                                        <span data-ng-switch-when="tag">
                                            <label class="fw-control-label">Key</label>
                                            <div class="fw-controls">
                                                <input type="text" data-ng-model="current.to.text" required />
                                            </div>
                                            <div data-ng-show="current.to.text" class="row margin-top-10">
                                                <label class="fw-control-label">Value</label>
                                                <div class="fw-controls">
                                                    <input type="text" data-ng-model="current.to.value" />
                                                </div>
                                            </div>
                                        </span>
                                        <span data-ng-switch-default>
                                            <!-- due to the nature of directives, we need another switch here -->
                                            <span data-ng-switch="current.to.type">
                                                <span data-ng-switch-when="subnet">
                                                    <label class="fw-control-label">Subnet</label>
                                                    <div class="fw-controls">
                                                        <input type="text" name="toValue" data-ng-model="toSubnet.address" data-ip required />
                                                    </div>
                                                    <div data-ng-show="current.to.text" class="row margin-top-10">
                                                        <label class="fw-control-label">CIDR</label>
                                                        <div class="fw-controls">
                                                            <select data-ng-options="c for c in CIDRs" data-ng-model="toSubnet.CIDR"> </select>
                                                        </div>
                                                    </div>
                                                </span>
                                                <span data-ng-switch-when="ip">
                                                    <label class="fw-control-label">IP</label>
                                                    <div class="fw-controls">
                                                        <input type="text" name="toValue" data-ng-model="current.to.text" data-ip required />
                                                    </div>
                                                </span>
                                                <span data-ng-switch-when="vm">
                                                    <label class="fw-control-label">UUID</label>
                                                    <div class="fw-controls">
                                                        <input type="hidden" class="select2-input" id="toInstanceSelect" />
                                                    </div>
                                                </span>
                                            </span>
                                            <!-- directives switch end -->
                                        </span>
                                        </span>
                                    </span>

                                    <span data-ng-switch="current.to.type">
                                        <span data-ng-switch-when="wildcard">
                                            <span>
                                                <span class="row">
                                                    <div class="margin-top-10">
                                                        <button class="btn light pull-right effect-orange-button" data-ng-disabled="current.to.text != 'vmall' && current.to.text != 'any'" data-ng-click="addTo()">Add</button>
                                                    </div>
                                                </span>
                                            </span>
                                        </span>
                                        <span data-ng-switch-when="tag">
                                            <span class="row">
                                                <div class="margin-top-10">
                                                    <button class="btn light pull-right effect-orange-button" data-ng-click="addTo()" data-ng-disabled="toForm.$invalid || toForm.$pristine">Add</button>
                                                </div>
                                            </span>
                                        </span>
                                        <span data-ng-switch-default>
                                            <span class="row">
                                                <div class="margin-top-10">
                                                    <button class="btn light pull-right effect-orange-button" data-ng-click="addTo()" data-ng-disabled="toForm.$invalid || toForm.$pristine">Add</button>
                                                </div>
                                            </span>
                                        </span>
                                    </span>
                    </div>


                    <div class="results-group">
                                        <span class="f-result" ng-hide="data.parsed.to.length">
                                            <div class="error" >
                                                No targets added
                                            </div>
                                        </span>
                                        <span data-ng-show="data.parsed.to.length" class="">
                                            <span class="f-result" data-ng-repeat="to in data.parsed.to">
                                                <div class="remove-icon delete pull-right tags-delete-pos" data-ng-click="removeTo($index)"></div>
                                                <div class="result-width">{{to|targetInfo}}</div>
                                            </span>
                                        </span>
                    </div>
                </td>
                </tr>
                </tbody>
                <tfoot>
                <tr>
                    <td>
                        <button class="btn light effect-orange-button" data-ng-show="data.uuid" data-ng-click="deleteRule(data)">Delete</button>
                        <button class="btn light effect-orange-button" data-ng-click="cancelRule()" data-translate-value>Cancel</button>
                        <button class="btn orange" data-ng-click="saveRule()" data-translate-value>{{data.uuid && 'Update Rule' || 'Create Rule'}}</button>
                    </td>
                </tr>
                </tfoot>
                </table>
            </div>
        </div>

        <div class="item-list-container">
            <div class="notice-block-wrapper pull-right">
                <div class="row notice-block" data-ng-show="notAffectedMachines.length > 0 || firewallDisabledMachines.length > 0 || kvmList.length > 0">
                    Cloud Firewall is a SmartDataCenter 7.0 platform feature. It currently supports SmartOS instances. <a href="http://wiki.joyent.com/wiki/display/jpc2/Working+With+Firewall+Rules">Click here to learn more about working with Firewall Rules</a>.
                    <br />
                </div>
                <div class="row notice-block" data-ng-show="notAffectedMachines.length > 0">
                    The following instances will not benefit from this feature until their global zone is upgraded by Joyent staff as part of the Q4 2013 through Q1 2014 maintenance:
                    <div data-ng-repeat="machine in notAffectedMachines">
                        <a href="#!/compute/instance/{{machine.id}}">{{$index+1}}. {{machine.name}} <span class="muted">({{machine.id}})</span></a>
                    </div>
                </div>
                <div class="row notice-block" data-ng-show="firewallDisabledMachines.length > 0">
                    The following instances do not have the Cloud Firewall feature enabled. You can view all of the rules that apply to each instance on their own Instance Details page. There you can also enable the Cloud Firewall or by using <a href="http://apidocs.joyent.com/cloudapi/#firewallrules">CloudAPI</a>:
                    <div data-ng-repeat="machine in firewallDisabledMachines">
                        <a href="#!/compute/instance/{{machine.id}}">{{$index+1}}. {{machine.name}} <span class="muted">({{machine.id}})</span></a>
                    </div>
                </div>
                <div class="row notice-block" data-ng-show="kvmList.length > 0">
                    Linux, BSD, and Windows instances are not yet supported:
                    <div data-ng-repeat="machine in kvmList">
                        <a href="#!/compute/instance/{{machine.id}}">{{$index+1}}. {{machine.name}} <span class="muted">({{machine.id}})</span></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
